<!DOCTYPE HTML>
<html>
	<head>
		<title>Line Chart</title>
		<script src="https://cdn.jsdelivr.net/npm/echarts@5.2.0/dist/echarts.min.js"></script>
		<link rel="stylesheet" href="../css/line.css"></script>
	</head>

	<body>
		<div id="chart" class="chart"></div>
		<script type="text/javascript">

			// Begin setup
			const READ_ONLY_TOKEN = "BBAU-MRoCiUPLmWFdZj8kvowA6QLepOQN59";
			const DEVICE_NAME = "stoneleigh-sm-kanzi-block";
			const VARIABLES = ["av-10cm", "av-20cm"];
			const UNIX_START_TIME = 1631748755 * 1000; // Convert to milliseconds
			const UNIX_END_TIME = 1632440109 * 1000; 
			// Optional
			const N_RESULTS_PER_PAGE = 10000; // Easier to work with a single page
			const RETURN_TYPE = "json";
			// End setup

			const urls = VARIABLES.map(function(_, i) {
				var url = "https://industrial.api.ubidots.com/api/v1.6/devices/" +
							DEVICE_NAME + "/" + VARIABLES[i] + "/values/?start=" +
							UNIX_START_TIME + "&end=" + UNIX_END_TIME +
							"&page_size=" + N_RESULTS_PER_PAGE + "&format=" + RETURN_TYPE;
				return url;
			});

			async function renderChart() {
				// TODO add error handling here
				try {
					const request = Array.from(Array(urls.length)).map(async function(_, i) {
						const req = await fetch(urls[i], {
							method: "GET",
							headers: {"X-Auth-Token": READ_ONLY_TOKEN}
						});
						return req.json();
					});

					const response = await Promise.all(request);
					return response;
				} catch (error) {
					console.log(error);
				}

			}

			renderChart().then((response) => {
				// TODO needs better error handling
				var series = response.map(function(_, i) {
					var data = response[i].results.map(function (value, index) {
						var date = new Date(value.timestamp).toLocaleString("en-AU");
						return [date, value.value];
					});
					return data;
				});

				var chartDom = document.getElementById('chart');
				var chart = echarts.init(chartDom);
				var options = {
					tooltip: {
						trigger: 'axis',
						axisPointer: {
							type: 'cross'
						}
					},
					toolbox: {
						show: true,
						feature: {
							saveAsImage: {}
						}
					},
					xAxis: {
						label: "Date",
						type: 'category'
					},
					yAxis: {
						label: "VWC (%)",
						type: 'value',
						min: 0,
						max: 100
					},
					series: [
					{
						name: VARIABLES[0],
						type: 'line',
						data: series[0].reverse(), // Reverse array as last value comes first
						markLine: {
							label: {
								formatter: "Wilting Point",
								position: "insideEndTop"
							},
							lineStyle: {
								color: '#333'
							},
							data: [{
								yAxis: 23
							}]
						}
					},
					{
						name: VARIABLES[1],
						type: 'line',
						data: series[1], 
						markLine: {
							label: {
								formatter: "Field Capacity",
								position: "insideEndTop"
							},
							lineStyle: {
								color: '#333'
							},
							data: [{
								yAxis: 72
							}]
						}
					}
					],
				};

				options && chart.setOption(options);
			});
		</script>
	</body>
</html>
