<!DOCTYPE HTML>
<html>
	<head>
		<title>Line Chart</title>
		<script src="https://cdn.jsdelivr.net/npm/echarts@5.2.0/dist/echarts.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<link rel="stylesheet" href="../css/line.css"></script>
	</head>

	<body>
		<div id="chart" class="chart"></div>
		<script type="text/javascript">// Token and device setup
			const READ_ONLY_TOKEN = "BBAU-MRoCiUPLmWFdZj8kvowA6QLepOQN59";
			const DEVICE_NAME = "stoneleigh-sm-kanzi-block";
			const VARIABLE_NAME = "av-10cm";

			// Time range and attributes
			const UNIX_START_TIME = 1631748755 * 1000; // Convert to milliseconds
			const UNIX_END_TIME = 1632440109 * 1000; 
			const N_RESULTS_PER_PAGE = 10000; // Easier to work with a single page
			const RETURN_TYPE = "json";
			const url = "https://industrial.api.ubidots.com/api/v1.6/devices/" +
						DEVICE_NAME + "/" + VARIABLE_NAME + "/values/?start=" +
						UNIX_START_TIME + "&end=" + UNIX_END_TIME +
						"&page_size=" + N_RESULTS_PER_PAGE + "&format=" + RETURN_TYPE;

			async function fetchValues() {
				const getValues = await fetch(url, {
					method: "GET",
					headers: {"X-Auth-Token": READ_ONLY_TOKEN}
				});
				const movies = await response.json();
				return movies;
			}

			fetchValues().then(response => {
				const series = response.results.map(function (value, index) {
					var date = new Date(value.timestamp);
					date = date.toLocaleString("en-AU");
					series.push([date, value.value]);
				});

				console.log(response.results);

				var chartDom = document.getElementById('chart');
				var chart = echarts.init(chartDom);
				var options = {
					tooltip: {
						trigger: 'axis',
						axisPointer: {
							type: 'cross'
						}
					},
					toolbox: {
						show: true,
						feature: {
							saveAsImage: {}
						}
					},
					xAxis: {
						label: "Date",
						type: 'category'
					},
					yAxis: {
						type: 'value'
					},
					series: [{
						type: 'line',
						data: series // Reverse array as last value comes first
					}]
				};

				options && chart.setOption(options);
			});
		

		</script>
	</body>
</html>
