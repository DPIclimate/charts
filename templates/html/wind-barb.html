<!DOCTYPE html>
<meta charset="utf-8">
<!--
  HighCharts.js - Wind Barb Chart
  Description: a line chart displaying wind speed and direction in a combined visualisation.
  Date: 17/01/2022
  Author: Ben Sefton
-->
<!--
     This is for local testing. The ubidots.js script simulates the Ubidots() interface available
     at runtime for the token and date range (and selected device for dynamic dashboards).

     See: https://help.ubidots.com/en/articles/2508317-html-canvas-interacting-with-account-data
-->
<script src="ubidots.js"></script>

<!-- Load highcharts.js -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/windbarb.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<!-- Load other req js -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

<!-- CSS Start -->
<style>
#container {
  height: 370px;
}

#csv {
  display: none;
}

.highcharts-figure,
.highcharts-data-table table {
  min-width: 320px;
  max-width: 700px;
  margin: 1em auto;
}

.highcharts-data-table table {
  font-family: Verdana, sans-serif;
  border-collapse: collapse;
  border: 1px solid #ebebeb;
  margin: 10px auto;
  text-align: center;
  width: 100%;
  max-width: 500px;
}

.highcharts-data-table caption {
  padding: 1em 0;
  font-size: 1.2em;
  color: #555;
}

.highcharts-data-table th {
  font-weight: 600;
  padding: 0.5em;
}

.highcharts-data-table td,
.highcharts-data-table th,
.highcharts-data-table caption {
  padding: 0.5em;
}

.highcharts-data-table thead tr,
.highcharts-data-table tr:nth-child(even) {
  background: #f8f8f8;
}

.highcharts-data-table tr:hover {
  background: #f1f7ff;
}
</style>
<!-- CSS End   -->

<div class="allHTML" style="text-align: center;">
  <!-- Add figure for chart -->
  <figure class="highcharts-figure">
    <div id="container"></div>
    <p class="highcharts-description">
        
    </p>
  </figure>
</div>

<!-- HighCharts script -->
<script>

  // Global variables
  var headers = {};
  const DEVICE_NAME = "00bac91837e6a3de";
  const dailyVARIABLES = ["daily_windspeed_avg", "daily_winddirection_avg"];
  const hourlyVARIABLES = ["hourly_windspeed_avg", "hourly_winddirection_avg"];
  const normalVARIABLES = ["windspeed", "winddirection"];
  const N_RESULTS_PER_PAGE = 10000; // Easier to work with a single page
  const RETURN_TYPE = "json";

  var ubidots = new Ubidots();
  var date = null;
  var timeseries = [];

  var gotToken = false;
  var gotDate = false;

  ubidots.on('receivedToken', function (data) {
      headers["X-Auth-Token"] = data;
      gotToken = true;

      doIt();
  });

  ubidots.on('selectedDashboardDateRange', function (data) {
      date = data;
      gotDate = true;
      doIt();
  });

  function initDate() {
        // Default 7 day view
        var startDate = moment().subtract(7, 'days');
        var endDate = moment();
        $('input[name="daterange"]').daterangepicker({
            timePicker: true,
            opens: 'left',
            startDate: startDate,
            endDate: endDate,
            locale: {
                format: "MM/DD hh:mm A"
            }
        }, function updateChart(start, end, label) {
            var date = {
                start: start.valueOf(),
                end: end.valueOf()
            };
            getDailyPrecip(date);
        });
        return {
            start: startDate.valueOf(),
            end: endDate.valueOf()
        };
    };

    // Multi API call function
    async function getData(date, VARIABLES) {
        // TODO add error handling here
        try {
            const urls = VARIABLES.map(function(_, i) {
                var url = "https://industrial.api.ubidots.com/api/v1.6/devices/" +
                            DEVICE_NAME + "/" + VARIABLES[i] + "/values/?start=" +
                            date.start + "&end=" + date.end +
                            "&page_size=" + N_RESULTS_PER_PAGE + "&format=" + RETURN_TYPE;
                return url;
            });
            const request = Array.from(Array(urls.length)).map(async function(_, i) {
                const req = await fetch(urls[i], {
                    method: "GET",
                    headers: headers
                });
                return req.json();
            });
            const response = await Promise.all(request);
            return response;
        } catch (error) {
            console.log(error);
        }
	}

    function displayChart(timeseries) {
        Highcharts.chart('container', {
            title: {
                text: ''
            },

            yAxis: {
                title: {
                text: 'Wind Speed m/s'
                }
            },

            xAxis: {
                type: 'datetime',
                offset: 40
            },
            series: [{
                type: 'windbarb',
                data: timeseries,
                name: 'Wind speed',
                color: Highcharts.getOptions().colors[1],
                showInLegend: false,
                tooltip: {
                    valueSuffix: ' m/s'
                }
            }, {
                type: 'area',
                keys: ['x', 'y'], // rotation is not used here
                data: timeseries,
                color: Highcharts.getOptions().colors[0],
                fillColor: {
                    linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                    stops: [
                        [0, Highcharts.getOptions().colors[0]],
                        [
                            1,
                            Highcharts.color(Highcharts.getOptions().colors[0])
                                .setOpacity(0.25).get()
                        ]
                    ]
                },
                name: 'Wind speed',
                tooltip: {
                    valueSuffix: ' m/s'
                },
                states: {
                    inactive: {
                        opacity: 1
                    }
                }
            }]
        });
    }

    function combineSeries(series){
        var combinedSeries = [];
        for(var i = 0; i < series[0].length; i++){
            // Timestamp, Wind Direction, Wind Speed (m/s)
            combinedSeries.push([series[0][i][0], series[0][i][1], series[1][i][1]]);
        }
        return combinedSeries.reverse();
    }

    function doIt() {
        if ( ! (gotDate === true && gotToken === true)) {
            console.log('Waiting on Ubidots info.');
            return;
        }

        var timeDiff = (date.end-date.start)/1000;

        console.log(timeDiff);

        var selectedRangeVars = [];

        if(timeDiff < (21600+1)){ // Less than 1 day selected
            var selectedRangeVars = normalVARIABLES;
        }else if(timeDiff > (21600+1) && timeDiff < (86400)+1){ // Less than 1 day more than 1/4 day (6hrs).
            // Use Hourly avg
            var selectedRangeVars = hourlyVARIABLES;
        }else if(timeDiff > (86400*2)+1){ // More than 1 day selected
            // Use daily avg
            var selectedRangeVars = dailyVARIABLES;
        }

        // 2 x API Request, wind direction and speed
        getData(date, selectedRangeVars).then((response) => {
				console.log(response);
                var series = response.map(function(_, i) {
					var data = response[i].results.map(function (value, index) {
						var date = new Date(value.timestamp);
						return [value.timestamp, value.value];
					});
					return data;
				});
                timeseries = combineSeries(series);
                displayChart(timeseries);
			});
    
        



    }

</script>
<!-- End High Charts script -->

